from django.shortcuts import render
from django.conf import settings
from django.http import JsonResponse

import subprocess
import datetime
import json
import pandas
from pandas.io.json import json_normalize
# work test
# import time
import mimetypes

# View
def main(request):
    return render(request, 'Vulnerability_Assessment/main.html', {})

# View test
# def load(request):
#     return render(request, 'Vulnerability_Assessment/load.html', {})
# def result(request):
#     return render(request, 'Vulnerability_Assessment/result.html', {})
# def caution(request):
#     return render(request, 'Vulnerability_Assessment/caution.html', {})
def ajax_test(request):
    return render(request, 'Vulnerability_Assessment/ajax_test.html', {})
def ajax_test2(request):
    return render(request, 'Vulnerability_Assessment/ajax_test2.html', {})
def ajax_test3(request):
    return render(request, 'Vulnerability_Assessment/ajax_test3.html', {})

# Model
def ajax_Vulnerability_Assessment(request):

    # work_リクエスト情報取得
    assessment_url = str(request.POST.get('assessment'))
    # assessment_url = "a"

    # work_ファイル出力用日付
    assessment_time = "{0:%Y%m%d_%H%M%S}".format(datetime.datetime.now())
    
    # work_セッションの保存
    # request.session['session_data'] = assessment_time
        
    # work_ファイル配置ディレクトリ
    output_directory = "./tmp/"

    # work_nikto実行ファイルディレクトリ
    nikto_directory = "Vulnerability_Assessment/program/nikto.pl -h"
    # nikto_directory = "Vulnerability_Assessment/program/nikto.pl -h http://www.example.com -o ./tmp/out.json"
    
    # work_実行変数
    exe = nikto_directory + " " + assessment_url + " -o " + output_directory + assessment_time + ".json"
    # exe_result = subprocess.run([exe], shell=True, check=True, encoding='utf-8', stderr=subprocess.PIPE, stdout=subprocess.PIPE, universal_newlines=True)
    # proc = subprocess.Popen("cat {} | cat -n; sleep 60".format('named_pipe'), shell=True, stdout=PIPE, stderr=PIPE, text=True)

    # work_実行
    exe_result = subprocess.Popen([exe], shell=True, stderr=subprocess.PIPE, stdout=subprocess.PIPE, encoding='utf-8')
    exe_result.wait()
    # time.sleep(15)

    # work_エラー処理
    # try:
    #     # work
    #     subprocess.run(exe, shell=True, check=True, encoding='utf-8', stderr=subprocess.PIPE, stdout=subprocess.PIPE, universal_newlines=True)
    #     # exe_result = subprocess.run(exe, shell=True, check=True, encoding='utf-8', stderr=subprocess.PIPE, stdout=subprocess.PIPE, universal_newlines=True)

    #     # work_出力時は翻訳_要検討
    # except subprocess.CalledProcessError:
    #     # work_エラー表示内容精査
    #     print('kamimura1: Failed to execute the external program.', file=sys.stderr)

    # if exe_result.returncode != 0:
    #     # work_エラー表示内容精査
    #     print('kamimura2: ls failed.', file=sys.stderr)
    #     sys.exit(1)

    # work_106 jsonファイルエラー処理(empty)
    
    json_file = './tmp/' + str(assessment_time) + '.json'
    mimetype = mimetypes.guess_type(json_file)
    # json_file = './tmp/testdata.json'

    json_open = open(json_file, 'r')
    # mimetype2 = mimetypes.guess_type(json_open)
    
    json_load = json.load(json_open)
    # mimetype3 = mimetypes.guess_type(json_load)
    # json_dumps = json.dumps(json_load)

    # work_テストレスポンス
    # json_load = {
    #     "assessment_url": str(assessment_url),
    #     "assessment_time": str(assessment_time),
    #     "output_directory": str(output_directory),
    #     "nikto_directory": str(nikto_directory),
    #     "exe": str(exe),
    #     "exe_result": str(exe_result),
    #     "json_file": str(json_file),
    #     "mimetype": str(mimetype),
        # "mimetype2": str(mimetype2),
        # "mimetype3": str(mimetype3),        
    # }

    return JsonResponse(json_load)

def ajax_json_view(request):

    json_data = str(request.POST.get('assessment_time'))
    
    json_file = './tmp/' + json_data + '.json'
    #json_file = './tmp/testdata.json'

    json_open = open(json_file, 'r')
    json_load = json.load(json_open)
    for count in json_load:
        j = {
            "request": str(request),             
            "OSVDB": str(json_load['vulnerabilities'][0]["OSVDB"]),
            "msg": str(json_load['vulnerabilities'][0]["msg"]),
        }
    
    return JsonResponse(j)

def ajax_json_view2(request):
    request_data = "./tmp/" + request + ".json"
    
    json_open = open(str(request_data), 'r')
    json_load = json.load(json_open)
    for count in json_load:
        j = {
            "request": str(request),            
            "OSVDB": str(json_load['vulnerabilities'][0]["OSVDB"]),
            "msg": str(json_load['vulnerabilities'][0]["msg"]),
        }
    
    return JsonResponse(j)

def json_view(request):

    json_file = './tmp/testdata.json'

    json_open = open(json_file, 'r')
    json_load = json.load(json_open)
    for count in json_load.values():
        v = {
            "request": str(request),             
            "OSVDB": str(json_load['vulnerabilities'][count]["OSVDB"]),
            "msg": str(json_load['vulnerabilities'][count]["msg"]),
        }    
    return JsonResponse(v)

def ajax_json_csv(request):

    # assessment_time = request
    assessment_time = "testdata"
    
    json_csv = pandas.read_json('./tmp/' + assessment_time + '.json')
    json_csv_normalize = json_normalize(json_csv['vulnerabilities'])
    json_csv_normalize.to_csv("./tmp/testdata.csv", encoding='utf-8')
    
    j = {
        "request": str(request),
        }
    
    return JsonResponse(j)

# exe_ajax_number
def ajax_number(request):
    now = datetime.datetime.now()
    time = "{0:%Y_%m_%d_%H_%M_%S}".format(now)
    number1 = int(request.POST.get('number1'))
    number2 = int(request.POST.get('number2'))
    plus = number1 + number2
    minus = number1 - number2
    d = {
        'plus': plus,
        'minus': minus,
        'time': time,
    }
    return JsonResponse(d)