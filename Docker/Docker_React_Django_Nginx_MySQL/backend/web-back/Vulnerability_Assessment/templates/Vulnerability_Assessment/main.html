<!DOCTYPE html>
{% load static %}
<html>
<head>
 
{% comment %} 参考サイト:https://www.tohoho-web.com/html/meta.htm {% endcomment %}
{% comment %} work_204 レスポンシブ対応 {% endcomment %}

<meta charset="utf-8"/>
{% comment %} work_202 ブラウザの互換設定 {% endcomment %}
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>

{% comment %} work_201 viewport設定(responsive) {% endcomment %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">

{% comment %} work_102 コンテンツセキュリティポリシー設定 {% endcomment %}
{% comment %} <meta http-equiv="content-security-policy" content="script-src 'self'; object-src 'none'"> {% endcomment %}

<!-- Cache-Control -->
<meta http-equiv="Cache-Control" content="no-cache">

{% comment %} work_301 公開情報整理 {% endcomment %}
<meta name="author" content="One_pair">
<meta name="description" content="WEBサイト脆弱性診断ツール">
<meta name="keywords" content="脆弱性診断,nikto">
{% comment %} <meta name="robots" content="noindex,nofollow"> {% endcomment %}

<title>脆弱性科クリニック</title>
{% comment %} work_101 css分離 {% endcomment %}
<!-- main.css -->
<link rel="stylesheet" type="text/css" id="applicationStylesheet" href="{% static 'css/main.css' %}"/>
<!-- roading.css -->
{% comment %} <link rel="stylesheet" type="text/css" id="applicationStylesheet" href="{% static 'css/loading.css' %}"/> {% endcomment %}
<!-- result.css -->
{% comment %} <link rel="stylesheet" type="text/css" id="applicationStylesheet" href="{% static 'css/result.css' %}"/> {% endcomment %}

</head>
<body>
<div id="flame_main">
	<div id="background">
		<div class="mainback">
			<div id="_1" rx="0" ry="0" x="0" y="0" width="556" height="600">
				<img src="{% static 'images/main_hospital.png' %}"  alt="" srcset="">
			</div>
		</div>
	</div>
	<div id="contents">

    {% comment %} work_104 メニューボタン実装 {% endcomment %}
    {% comment %} work_203 フッターレイアウト調整 {% endcomment %}
		<div class="can_btn">
			<div id="can_btn" rx="0" ry="0" x="0" y="0" width="136" height="40">
				<a href=""><img src="{% static 'images/can_btn.png' %}" alt="" srcset=""></a>
			</div>
		</div>
		<div class="clo_btn">
			<div id="clo_btn" rx="0" ry="0" x="0" y="0" width="136" height="40">
				<a href=""><img src="{% static 'images/clo_btn.png' %}" alt="" srcset=""></a>
			</div>
		</div>
		<div class="ret_btn">
			<div id="ret_btn" rx="0" ry="0" x="0" y="0" width="136" height="40">
				<a href=""><img src="{% static 'images/ret_btn.png' %}" alt="" srcset=""></a>
			</div>
		</div>
		<div class="rep_btn">
			<div id="rep_btn" rx="0" ry="0" x="0" y="0" width="136" height="40">
                <form id="ajax-json-csv" action="{% url 'Vulnerability_Assessment:ajax_json_csv' %}" method="POST">
                {% csrf_token %}
                <input class="" type="hidden" id="rep_assessment" required>
                <input type="image" src={% static "images/rep_btn.png" %} alt="" srcset="">
                </form>
			</div>
		</div>

		<article class="mainback_form">
			<div class="back_indom">
				<div id="back_indom" rx="0" ry="0" x="0" y="0" width="460" height="46">
					<img src="{% static 'images/indom_bar.png' %}" alt="" srcset="">
				</div>
			</div>
		    <form id="ajax-Vulnerability-Assessment" action="{% url 'Vulnerability_Assessment:ajax_Vulnerability_Assessment' %}" method="POST">
            	{% csrf_token %}
            	<input class="indom" type="text" id="assessment" required>
				<div class="enter_btn">
					<div id="enter_btn" rx="0" ry="0" x="0" y="0" width="120" height="110">
            		<button type="submit" ><img src="{% static 'images/ent_btn.png' %}" alt="" srcset=""></button>
					</div>
				</div>
        	</form>
		</article>
	</div>
	{% comment %} work_xxx test class {% endcomment %}
	<footer class="result">
		<p>Copyright &copy; 2021 ONE_pair</p>
		<p>This program is a free software; you may redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.</p>
		<p>This program is a distributed in the hope that it will be useful,but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
		<p>You should have received a copy of the GNU General Public License along with this program. If not, see <a href="http://www.gnu.org/licenses/.">http://www.gnu.org/licenses/.</a></p>
	</footer>
</div>

<!-- Loading jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

{% comment %} work_103 js分離 {% endcomment %}
<!-- CSRF token processing -->
{% comment %} <script id="applicationScript" type="text/javascript" src="{% static 'js/main.js' %}"></script> {% endcomment %}
<script>
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    // Ajax Internal processing
    $('#ajax-Vulnerability-Assessment').on('submit', function(e) {
        e.preventDefault();

        assessment = document.getElementById("assessment").value;

        // Ajax View change
        $('.mainback').empty();
        $('.mainback_form').empty();
        $('.mainback').prepend('<img src={% static "images/diagnose_mugen.gif" %} alt="">');

        // Ajax Request
        $.ajax({
            'url': '{% url "Vulnerability_Assessment:ajax_Vulnerability_Assessment" %}',
            'type': 'POST',
            'data': {
                'assessment': assessment,
            },
            'dataType': 'json'
        })

        // Response processing
        .done(function(response){

        // Ajax View change
            $('.mainback').empty();
            $('.mainback').prepend('<img src={% static "images/board.png" %} alt="">');

            // header
            $('#contents').prepend('<div id="valdb_ip"><div class="ip_num"><div id="ip_num" rx="0" ry="0" x="0" y="0" width="184" height="32"></div></div><div class="ip_bar"><div id="ip_bar" rx="0" ry="0" x="0" y="0" width="110" height="24"><img src={% static "images/ip_bar.png" %} alt="" srcset=""></div></div><div class="domain_name"><div id="domain_name" rx="0" ry="0" x="0" y="0" width="462" height="68"></div></div><div class="domain_bar"><div id="domain_bar" rx="0" ry="0" x="0" y="0" width="110" height="38"><img src={% static "images/domain_bar.png" %} alt="" srcset=""></div></div>');
            $('#contents').prepend('<div class="vdbno_bar"><div id="vdbno_bar" rx="0" ry="0" x="0" y="0" width="285" height="28"><img src={% static "images/vdbno_bar.png" %} alt="" srcset=""></div></div><div class="vdetail_bar"><div id="vdetail_bar" rx="0" ry="0" x="0" y="0" width="569" height="28"><img src={% static "images/vdetail_bar.png" %} alt="" srcset=""></div></div>');

            // teble
            $('#contents').prepend('<div id="valdb_tb"><table id="view_table"></table></div>');

            // work_105 ソースリフファクタリング
            json_response = JSON.stringify(response);
            json_response = JSON.parse(json_response);
            json_result_host = json_response.host;
            json_result_ip = json_response.ip;

            // add infomation
            $('#domain_name').prepend('<p>' + json_result_host + '</p>');
            $('#ip_num').prepend('<p>' + json_result_ip + '</p>');

            // add column
            json_length = Object.keys(json_response['vulnerabilities']).length;
            for (var count = 0; count < json_length; count++) {
                json_result_OSVDB = json_response.vulnerabilities[count].OSVDB;
                json_result_msg = json_response.vulnerabilities[count].msg;
                // work_108
                json_result_method = json_response.vulnerabilities[count].method;
                json_result_url = json_response.vulnerabilities[count].url;

                $('#view_table').prepend('<tr><td class="td_no">OSVDB-' + json_result_OSVDB + '</td><td class="td_text">' + json_result_msg + ' </td><td class="td_detail"><form id="ajax-json-view" action="{% url 'Vulnerability_Assessment:ajax_json_view' %}" method="POST">{% csrf_token %}<button type="submit" onclick="clickBtn1()" ><img src={% static "images/detail_icon.png" %} alt="" srcset=""></button></form></td></tr>');
            }

            // work_テストレスポンス
            // $('.result').prepend('<p>RESULT_assessment_url：' + json_response.assessment_url + '</p>');
            // $('.result').prepend('<p>RESULT_assessment_time：' + json_response.assessment_time + '</p>');
            // $('.result').prepend('<p>RESULT_output_directory：' + json_response.output_directory + '</p>');
            // $('.result').prepend('<p>RESULT_nikto_directory：' + json_response.nikto_directory + '</p>');
            // $('.result').prepend('<p>RESULT_exe：' + json_response.exe + '</p>');
            // $('.result').prepend('<p>RESULT_exe_result：' + json_response.exe_result + '</p>');
            // $('.result').prepend('<p>RESULT_json_file：' + json_response.json_file + '</p>');
            // $('.result').prepend('<p>RESULT_mimetype：' + json_response.mimetype + '</p>');
            // $('.result').prepend('<p>RESULT_mimetype2：' + json_response.mimetype2 + '</p>');
            // $('.result').prepend('<p>RESULT_mimetype3：' + json_response.mimetype3 + '</p>');

            // work_106 計測時間取得
            {% comment %} window.sessionStorage.setItem(['assessment_time'],[response.assessment_time]); {% endcomment %}

        })
        // .fail(function(response){
        //     $('.result').prepend('<p>引き算結果：' + response.minus + '</p>');
        //     $('.result').prepend('<p>足し算結果：' + response.plus + '</p>');
        // })
        ;
    });

    // work_108
    // report view
    {% comment %} function clickBtn1 {

        // View change
        $('.mainback').empty();
        $('.result').prepend('<p>RESULT：' + 'aaa' + '</p>');

    } {% endcomment %}

    {% comment %} // work_xxx test
    // Internal processing
    $('#ajax-json-csv').on('image', function(e) {
        e.preventDefault();

        // var assessment_time = window.sessionStorage.getItem(['assessment_time']);
        var assessment_time = 'testdata';

        $.ajax({
            'url': '{% url "Vulnerability_Assessment:ajax_json_csv" %}',
            'type': 'POST',
            'data': {
                'assessment_time': assessment_time,
            },
            'dataType': 'json'
        })
        .done(function(response){
            $('.result').prepend('<p>RESULT：CSV_output</p>');
        })
        // .fail(function(response){
        //     $('.result').prepend('<p>引き算結果：' + response.minus + '</p>');
        //     $('.result').prepend('<p>足し算結果：' + response.plus + '</p>');
        // })
        ;
    }); {% endcomment %}

</script>
</body>
</html>