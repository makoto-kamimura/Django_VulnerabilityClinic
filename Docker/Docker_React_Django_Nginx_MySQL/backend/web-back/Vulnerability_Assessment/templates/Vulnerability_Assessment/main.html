<!DOCTYPE html>
{% load static %}
<html>
<head>
<meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WEB脆弱性診断</title>
<link rel="stylesheet" type="text/css" id="applicationStylesheet" href="{% static 'css/main.css' %}"/>
{% comment %} <link rel="stylesheet" type="text/css" id="applicationStylesheet" href="{% static 'css/result.css' %}"/> {% endcomment %}

<!-- Loading jQuery -->
{% comment %} <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> {% endcomment %}
<!-- CSRF token processing -->
{% comment %} <script id="applicationScript" type="text/javascript" src="{% static 'js/main.js' %}"></script> {% endcomment %}
</head>
<body>
<div id="flame_main">
	<div id="background">
		<!-- <svg class="background_q">
			<rect id="background_q" rx="0" ry="0" x="0" y="0" width="1920" height="1080">
			</rect>
		</svg> -->
		<div class="mainback">
			<div id="_1" rx="0" ry="0" x="0" y="0" width="556" height="600">
				<img src="{% static 'images/main_hospital.png' %}"  alt="" srcset="">
			</div>
		</div>
	</div>
	<div id="contents">
		<!-- ↓ここから…メニューボタン↓ -->
		{% comment %} <div class="can_btn">
			<div id="can_btn" rx="0" ry="0" x="0" y="0" width="136" height="40">
				<a href=""><img src="{% static 'images/can_btn.png' %}" alt="" srcset=""></a>
			</div>
		</div>
		<div class="clo_btn">
			<div id="clo_btn" rx="0" ry="0" x="0" y="0" width="136" height="40">
				<a href=""><img src="{% static 'images/clo_btn.png' %}" alt="" srcset=""></a>
			</div>
		</div>
		<div class="ret_btn">
			<div id="ret_btn" rx="0" ry="0" x="0" y="0" width="136" height="40">
				<a href=""><img src="{% static 'images/ret_btn.png' %}" alt="" srcset=""></a>
			</div>
		</div> {% endcomment %}
        
		<div class="rep_btn">
			<div id="rep_btn" rx="0" ry="0" x="0" y="0" width="136" height="40">

				{% comment %} <a href=""><img src="{% static 'images/rep_btn.png' %}" alt="" srcset=""></a> {% endcomment %}
                <form id="ajax-json-csv" action="{% url 'Vulnerability_Assessment:ajax_json_csv' %}" method="POST" hidden>
                {% csrf_token %}
                <input class="" type="hidden" id="assessment" required>
                <input type="image" src={% static "images/rep_btn.png" %} alt="" srcset="">
                </form>

			</div>
		</div>

		<!-- ↑ここまで…メニューボタン↑ -->
		<article class="mainback_form">
			<div class="back_indom">
				<div id="back_indom" rx="0" ry="0" x="0" y="0" width="460" height="46">
					<img src="{% static 'images/indom_bar.png' %}" alt="" srcset="">
				</div>
			</div>
		    <form id="ajax-Vulnerability-Assessment" action="{% url 'Vulnerability_Assessment:ajax_Vulnerability_Assessment' %}" method="POST">
            	{% csrf_token %}
            	<input  class="indom" type="text" id="assessment" required>
				<div class="enter_btn">
					<div id="enter_btn" rx="0" ry="0" x="0" y="0" width="120" height="110">
            		<button type="submit" ><img src="{% static 'images/ent_btn.png' %}" alt="" srcset=""></button>
					</div>
				</div>
        	</form>
		</article>
	</div>
	{% comment %} work test class {% endcomment %}
	<footer class="result">
		<p>Copyright (c) 2021 ONE_pair<br>
			This program is a free software; you may redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.<br>
			This program is a distributed in the hope that it will be useful,but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.<br>
			You should have received a copy of the GNU General Public License along with this program. If not, see <a href="http://www.gnu.org/licenses/.">http://www.gnu.org/licenses/.</a></p>
	</footer>
</div>

<!-- Loading jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!-- CSRF token processing -->
    <script>
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        // Internal processing
        $('#ajax-Vulnerability-Assessment').on('submit', function(e) {
            e.preventDefault();

			// Value get
			var assessment = $('#assessment').val();

            // Loading processing
			// delete
            $('.mainback').empty();
			$('.mainback_form').empty();
			// create
            $('.mainback').prepend('<img src={% static "images/diagnose_mugen.gif" %} alt="">');

			// Request processing
            $.ajax({
                'url': '{% url "Vulnerability_Assessment:ajax_Vulnerability_Assessment" %}',
                'type': 'POST',
                'data': {
                    'assessment': assessment,
                },
                'dataType': 'json'
            })

			// Response processing
            .done(function(response){
				// delete
	            $('.mainback').empty();
				// create
	            $('.mainback').prepend('<img src={% static "images/board.png" %} alt="">');

                // ip infomation
	            $('#contents').prepend('<div id="_2"><div id="_1"><div class="ip_num"><div id="ip_num" rx="0" ry="0" x="0" y="0" width="184" height="32"></div></div><div class="ip_bar"><div id="ip_bar" rx="0" ry="0" x="0" y="0" width="110" height="24"><img src={% static "images/ip_bar.png" %} alt="" srcset=""></div></div><div class="domain_name"><div id="domain_name" rx="0" ry="0" x="0" y="0" width="462" height="68"></div></div><div class="domain_bar"><div id="domain_bar" rx="0" ry="0" x="0" y="0" width="110" height="38"><img src={% static "images/domain_bar.png" %} alt="" srcset=""></div></div></div>');

                // table header
	            $('#contents').prepend('<div class="vdbno_bar"><div id="vdbno_bar" rx="0" ry="0" x="0" y="0" width="285" height="28"><img src={% static "images/vdbno_bar.png" %} alt="" srcset=""></div></div><div class="vdetail_bar"><div id="vdetail_bar" rx="0" ry="0" x="0" y="0" width="569" height="28"><img src={% static "images/vdetail_bar.png" %} alt="" srcset=""></div></div>');

                // teble
	            $('#contents').prepend('<div id="valdb_tb"><table id="view_table"></table></div>');

                // teble tr test
	            {% comment %} $('#view_table').prepend('<tr><td class="td_no">OSVDB-0001</td><td class="td_text">この文章はダミーです。内容に意味はありませんので、文字の大きさや雰囲気をご確認ください。</td><td class="td_detail"><form id="ajax-json-view" action="{% url 'Vulnerability_Assessment:ajax_json_view' %}" method="POST">{% csrf_token %}<input class="" type="hidden" id="assessment" required><input type="image" src={% static "images/detail_icon.png" %} alt="" srcset=""></form></td></tr>'); {% endcomment %}

                //
                json_response = JSON.stringify(response);
                json_response = JSON.parse(json_response);

                json_result2 = json_response.host;
                json_result3 = json_response.ip;

	            $('#ip_num').prepend('<p>' + json_result3 + '</p>');
	            $('#domain_name').prepend('<p>' + json_result2 + '</p>');

                json_length = Object.keys(json_response['vulnerabilities']).length;

                for (var count = 0; count < json_length; count++) {
                    json_result = json_response.vulnerabilities[count].msg;
                    json_result1 = json_response.vulnerabilities[count].OSVDB;

	                $('#view_table').prepend('<tr><td class="td_no">OSVDB-' + json_result1 + '</td><td class="td_text">' + json_result + ' </td><td class="td_detail"><form id="ajax-json-view" action="{% url 'Vulnerability_Assessment:ajax_json_view' %}" method="POST">{% csrf_token %}<input class="" type="hidden" id="assessment" required><input type="image" src={% static "images/detail_icon.png" %} alt="" srcset=""></form></td></tr>');
                }

                $('.result').prepend('<p>RESULT：' + json_result + '</p>');

                //

	            {% comment %} $('#contents').prepend('<div id="valdb_tb"><table><tr><td class="td_no">OSVDB-0001</td><td class="td_text">この文章はダミーです。内容に意味はありませんので、文字の大きさや雰囲気をご確認ください。</td><td class="td_detail"><form id="ajax-json-view" action="{% url 'Vulnerability_Assessment:ajax_json_view' %}" method="POST">{% csrf_token %}<input class="" type="hidden" id="assessment" required><input type="image" src={% static "images/detail_icon.png" %} alt="" srcset=""></form></td></tr></table></div></td></tr></table></div>'); {% endcomment %}

                {% comment %} $('.result').prepend('<p>RESULT：' + response.assessment + '</p>');
                $('.result').prepend('<p>RESULT：' + response.assessment_time + '</p>');
                $('.result').prepend('<p>RESULT：' + response.session_data + '</p>'); {% endcomment %}

				//詳細情報参照用
                {% comment %} window.sessionStorage.setItem(['assessment_time'],[response.assessment_time]); {% endcomment %}

                //test
                //assessment_time = window.sessionStorage.getItem(['assessment_time']);
                //$('.result').prepend('<p>RESULTRESULT：：' + assessment_time + '</p>');

            })
            // .fail(function(response){
            //     $('.result').prepend('<p>引き算結果：' + response.minus + '</p>');
            //     $('.result').prepend('<p>足し算結果：' + response.plus + '</p>');
            // })
            ;
        });

        // Internal processing
        $('#ajax-json-view').on('image', function(e) {
            e.preventDefault();

            // var assessment_time = window.sessionStorage.getItem(['assessment_time']);
            var assessment_time = 'testdata';

            $.ajax({
                'url': '{% url "Vulnerability_Assessment:ajax_json_view" %}',
                'type': 'POST',
                'data': {
                    'assessment_time': assessment_time,
                },
                'dataType': 'json'
            })
            .done(function(response){
                // work_OSVDB:msg
                $('.result').prepend('<p>RESULT：' + response.OSVDB + ':' + response.msg + '</p>');
            })
            // .fail(function(response){
            //     $('.result').prepend('<p>引き算結果：' + response.minus + '</p>');
            //     $('.result').prepend('<p>足し算結果：' + response.plus + '</p>');
            // })
            ;
        });

        // Internal processing
        $('#ajax-json-csv').on('image', function(e) {
            e.preventDefault();

            // var assessment_time = window.sessionStorage.getItem(['assessment_time']);
            var assessment_time = 'testdata';

            $.ajax({
                'url': '{% url "Vulnerability_Assessment:ajax_json_csv" %}',
                'type': 'POST',
                'data': {
                    'assessment_time': assessment_time,
                },
                'dataType': 'json'
            })
            .done(function(response){
                $('.result').prepend('<p>RESULT：CSV_output</p>');
            })
            // .fail(function(response){
            //     $('.result').prepend('<p>引き算結果：' + response.minus + '</p>');
            //     $('.result').prepend('<p>足し算結果：' + response.plus + '</p>');
            // })
            ;
        });

    </script>
</body>
</html>